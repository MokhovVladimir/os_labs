# Создание ansible скрипта для создания распределителя нагрузки на haproxy и системы VIP на keepalived
В этой папке создан ansible скрипт, который настраивает работу серверов и распределителя нагрузки,

а также для повышения откзаустойчивости системы настраивает виртуальный ip-адрес.

Для подробного ознакомления с параметрами проекта, необходимо прочитать про каждого файла.

## Файлы в проекте
## *1. Inventory-файл*
Это самый основной конфигурационный файл. 
В нем есть две группы:
* webservers

    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который на себе будет содержать html страницу.
* balancer

    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который на себе будут содержать балансировщик трафика соответвественно. 


## *2. ansible.cfg*
Содержит в себе следующие параметры:
1. Указываем inventory файл
2. Указываем пользователя, с которомы мы работаем
3. Нужно ли осуществлять host_key_checking
4. Парметр defualt_transport. (параемтр smart ставит автоматическое переключение ммежду ssh и paramiko в зависимости от ОС)


## *3. VagrantFile*
Этот файл необходим для быстрого поднятия виртуальных машин. Он не связан с ansible скриптом, а служит служебным файлом для проверки работоспособности playbook`а.


## *4. nginx.yml*
Является основным основным playbook-файлом для установки ПО на сервера.
Содержит в себе запуск 3 ролей, о которых будет прописано далее. Каждая из них запускается в зависимости от принадлежности хоста одной из групп. Общая настройка (Disabled selinux) запускается внезависимости от групп, так как является обязательной настройкой системы.

# ***Папка Roles***
Основная папка проекта. Содержит три типа ролей, каждая из которых выполняет свою функцию. Подробнее о каждой роли написано ниже.
## 1. selinux-disabled
Общая настройка всех устройств в этой схеме. Отключает системную защиту, препядствующую работе серверов и перезагружает сервер.
Результат для трех пк: 3 changed

## 2. balancer
Настраивает сервера-балансировщиков.

Устанавливает haproxy и keepalived и меняет их конфигурационные файлы, настраивая балансировщик в режим round robin, а виртуальный ip-адрес на тот, что указан в переменной virtual_ip (/vars/main.yml).

Шаблон конфигурационный файлов лежит в папке templates.


Результат 6 success, 2 changed

## 3. webservers
Настраивает веб-сервера. Устанавливает на них nginx, изменяет конфигурационный файл и меняет html-документ, подгружающийся на этот сервер.
Для наглядности html-документ изменен таким образом, чтобы увидеть работоспособность распределителя нагрузки.

Запуск и использования ansible playbook
======================================
## 1. inventory
Первым этапом необходимо изменить inventory-файл. В него внести ip-адреса и имена хостов.

Для серверов балансировки указывается приоритет, в зависимости от которого сервер будет выбираться в качестве основного маршрутизатора.

## 2. Шаблоны
Этот этап не является обязательным, однако для работы его необходимо учитывать. В /roles/webservers/templates необходимо изменть шаблон html-документа (файл index.html.j2).
## 3. Запуск playbook
Если необходимо полностью установить все компоненты, описанные в ролях, нужно написать в терминале 
"ansible-playbook nginx.yml"
Эта команда выполнит все task файлы из всех ролей. 

Однако не всегда некоторые параметры являются необходимыми. Для этого написаны специальные теги, по которым можно запустить отдельный элемент.

#### 1. html

Этот тег меняет конфигурацонный файл nginx на веб-серверах

#### 2. balancer

Выполняет настройку серверов-балансировщиков

#### 3. selinux

Выполняет отключение selinux на всех серверах


# ***Результат***
В результате мы настраиваем веб-сервера и 2 балансировщика.

При выходи одного из них, автоматически ip-адрес переходит на второй и распределение нагрузки
продолжает работать.
