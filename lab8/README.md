# Создание ansible скрипта для создания распределителя нагрузки на haproxy и системы VIP на keepalived
В этой папке создан ansible скрипт, который настраивает работу кластера серверов для сбора метрик prometheus.

Для подробного ознакомления с параметрами проекта, необходимо прочитать про каждого файла.

## Файлы в проекте
## *1. Inventory-файл*
Это самый основной конфигурационный файл. 
В нем есть две группы:
* prometheus

    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который на себе содержать базу данных prometheus.
* nodeexporter

    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который содержать клиента prometheus.
* grafana
    
    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который содержать визуализацию метрик (настроено до web-настройки).


## *2. ansible.cfg*
Содержит в себе следующие параметры:
1. Указываем inventory файл
2. Указываем пользователя, с которомы мы работаем
3. Нужно ли осуществлять host_key_checking
4. Парметр defualt_transport. (параемтр smart ставит автоматическое переключение ммежду ssh и paramiko в зависимости от ОС)


## *3. VagrantFile*
Этот файл необходим для быстрого поднятия виртуальных машин. Он не связан с ansible скриптом, а служит служебным файлом для проверки работоспособности playbook`а.


## *4. sirius.yml*
Является основным основным playbook-файлом для установки ПО на сервера.
Содержит в себе запуск 3 ролей, о которых будет прописано далее. Каждая из них запускается в зависимости от принадлежности хоста одной из групп. Общая настройка (Disabled selinux) запускается внезависимости от групп, так как является обязательной настройкой системы.

# ***Папка Roles***
Основная папка проекта. Содержит три типа ролей, каждая из которых выполняет свою функцию. Подробнее о каждой роли написано ниже.
## 1. selinux-disabled
Общая настройка всех устройств в этой схеме. Отключает системную защиту, препядствующую работе серверов и перезагружает сервер.
Результат для трех пк: 3 changed

## 2. Prometheus
Настраивает сервер базы данных.

Установка пакетов происходит автоматически.

Роль содержит в себе директорию templates, в которой находятся шаблоны конфигурационных файлов. Для удобства их изменения основные параметры вынесены в соответсвующие переменные в папке vars.


## 3. nodeexporter
Настраивает сервер, с которого будут сниматься метрики.
Передает на сервер файлы необходимые для настройки (пакет установки и сервис) из дириктории /files.

## 4. grafana
Настраивает сервер визуализации.
Итогом является настройка web-интерфейса, так как дальнейшая настройка производится вручную.

Запуск и использования ansible playbook
======================================
## 1. inventory
Первым этапом необходимо изменить inventory-файл. В него внести ip-адреса и имена хостов.

Для серверов балансировки указывается приоритет, в зависимости от которого сервер будет выбираться в качестве основного маршрутизатора.

## 2. Шаблоны
Этот этап не является обязательным, однако для работы его необходимо учитывать. В /roles/webservers/templates необходимо изменть шаблон html-документа (файл index.html.j2).
## 3. Запуск playbook
Если необходимо полностью установить все компоненты, описанные в ролях, нужно написать в терминале 
"ansible-playbook nginx.yml"
Эта команда выполнит все task файлы из всех ролей. 

Однако не всегда некоторые параметры являются необходимыми. Для этого написаны специальные теги, по которым можно запустить отдельный элемент.

#### 1. prometheus

Этот тег запускает роль prometheus

#### 2. nodeexporter

Выполняет настройку сервера nodeexporter

#### 3. selinux

Выполняет отключение selinux на всех серверах

#### 4. grafana

Выполняет настройку сервера grafana


# ***Результат***
В результате мы настраиваем кластер сбора и визуализации метрик.

На сайте отображается информация, полученная из базы данных.
Результат представлен по ссылкам
### База данных

http://192.168.11.90:9090/targets 

### Веб-интерфейс 

http://192.168.11.70:3000/login

