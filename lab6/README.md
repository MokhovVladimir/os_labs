# Создание ansible скрипта для создания распределителя нагрузки на haproxy и системы VIP на keepalived
В этой папке создан ansible скрипт, который настраивает работу серверов и распределителя нагрузки,

а также для повышения откзаустойчивости системы настраивает виртуальный ip-адрес.

Для подробного ознакомления с параметрами проекта, необходимо прочитать про каждого файла.

## Файлы в проекте
## *1. Inventory-файл*
Это самый основной конфигурационный файл. 
В нем есть две группы:
* webservers

    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который на себе будет содержать html страницу.
* init-db

    Содержит в себе имя хоста первым параметром и ip-адрес сервера, который содержать базу данных. 


## *2. ansible.cfg*
Содержит в себе следующие параметры:
1. Указываем inventory файл
2. Указываем пользователя, с которомы мы работаем
3. Нужно ли осуществлять host_key_checking
4. Парметр defualt_transport. (параемтр smart ставит автоматическое переключение ммежду ssh и paramiko в зависимости от ОС)


## *3. VagrantFile*
Этот файл необходим для быстрого поднятия виртуальных машин. Он не связан с ansible скриптом, а служит служебным файлом для проверки работоспособности playbook`а.


## *4. nginx.yml*
Является основным основным playbook-файлом для установки ПО на сервера.
Содержит в себе запуск 3 ролей, о которых будет прописано далее. Каждая из них запускается в зависимости от принадлежности хоста одной из групп. Общая настройка (Disabled selinux) запускается внезависимости от групп, так как является обязательной настройкой системы.

# ***Папка Roles***
Основная папка проекта. Содержит три типа ролей, каждая из которых выполняет свою функцию. Подробнее о каждой роли написано ниже.
## 1. selinux-disabled
Общая настройка всех устройств в этой схеме. Отключает системную защиту, препядствующую работе серверов и перезагружает сервер.
Результат для трех пк: 3 changed

## 2. Init-db
Настраивает сервер базы данных.

Передает на сервер файл small.sql из дириктории /files. После передачи создает из образа базу данных и пользователя в ней. Пароль от пользователя postgres указывается в глобальных переменных переменных в разделе Init-db.

Роль содержит в себе директорию templates, в которой находятся шаблоны конфигурационных файлов. Для удобства их изменения основные параметры вынесены в соответсвующие переменные в папке group_vars.

Результат 6 success, 2 changed

## 3. webservers
Настраивает веб-сервера. Устанавливает на них nginx и php, изменяет конфигурационный файл и меняет html-документ, подгружающийся на этот сервер.
Для наглядности html-документ изменен таким образом, чтобы увидеть работоспособность php модуля. На сайте выводится информация из базы данных, запрос в которую можно изменить в соответсвующей переменной в разделе Webserver.

Запуск и использования ansible playbook
======================================
## 1. inventory
Первым этапом необходимо изменить inventory-файл. В него внести ip-адреса и имена хостов.

Для серверов балансировки указывается приоритет, в зависимости от которого сервер будет выбираться в качестве основного маршрутизатора.

## 2. Шаблоны
Этот этап не является обязательным, однако для работы его необходимо учитывать. В /roles/webservers/templates необходимо изменть шаблон html-документа (файл index.html.j2).
## 3. Запуск playbook
Если необходимо полностью установить все компоненты, описанные в ролях, нужно написать в терминале 
"ansible-playbook nginx.yml"
Эта команда выполнит все task файлы из всех ролей. 

Однако не всегда некоторые параметры являются необходимыми. Для этого написаны специальные теги, по которым можно запустить отдельный элемент.

#### 1. web

Этот тег меняет конфигурацонный файл nginx, php-fpm и html-документ сервера на веб-серверах

#### 2. init-db

Выполняет настройку сервера базы данных

#### 3. selinux

Выполняет отключение selinux на всех серверах


# ***Результат***
В результате мы настраиваем веб-сервер и сервер базы данных.

На сайте отображается информация, полученная из базы данных.
Результат представлен по ссылке

http://192.168.11.80:8080/index.php
